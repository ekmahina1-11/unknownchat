<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>UnknownChat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body,html{margin:0;height:100%;font-family:Arial;background:#e5ddd5}
#login,#chat{max-width:420px;margin:auto;height:100%}
#login{display:flex;flex-direction:column;justify-content:center;padding:20px}
input,button{padding:12px;margin:6px 0;font-size:16px}
button{background:#128c7e;color:#fff;border:none}
#chat{display:none;flex-direction:column}
#header{background:#075e54;color:#fff;padding:10px;display:flex;justify-content:space-between;align-items:center}
#messages{flex:1;overflow-y:auto;padding:10px}
.msg{max-width:70%;padding:8px;border-radius:8px;margin:6px 0}
.right{margin-left:auto;background:#dcf8c6}
.left{background:#fff}
.small{font-size:10px;text-align:right}
.pink{color:#e91e63}
.date{font-size:12px;text-align:center;color:#555;margin:10px}
#typing{font-size:12px;color:#555;padding-left:10px;height:18px}
#sendBox{display:flex;background:#fff;padding:5px}
#sendBox input{flex:1}
.eye{cursor:pointer;margin-left:-30px}
</style>
</head>

<body>

<div id="login">
<h2>UnknownChat</h2>
<input id="username" placeholder="Username">
<div style="display:flex;align-items:center">
<input id="password" type="password" placeholder="Password" style="flex:1">
<span class="eye" onclick="togglePass()">üëÅÔ∏è</span>
</div>
<button onclick="login()">Login</button>
<p id="error"></p>
</div>

<div id="chat">
<div id="header">
<div>
<div id="headerName"></div>
<div id="headerStatus"></div>
</div>
<button onclick="logout()">Logout</button>
</div>

<div id="messages"></div>
<div id="typing"></div>

<div id="sendBox">
<input id="msg" placeholder="Type a message">
<button onclick="send()">Send</button>
</div>
</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyB57DbuZWjQjaekNFkUrYmABql_yl-KFnA",
 authDomain:"unknownchat-bbd4b.firebaseapp.com",
 projectId:"unknownchat-bbd4b"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const users={
 foreverus10:{email:"unknownmarch1@gmail.com",chat:"Kakka"},
 foreverus29:{email:"unknownmarch001@gmail.com",chat:"Bacha"}
};

let me="",other="",typingTimer;

function togglePass(){
 password.type=password.type==="password"?"text":"password";
}

function login(){
 const u=username.value,p=password.value;
 if(!users[u]){error.innerText="Invalid user";return;}
 auth.signInWithEmailAndPassword(users[u].email,p).then(()=>{
  me=u; other=Object.keys(users).find(x=>x!==u);
  login.style.display="none"; chat.style.display="flex";
  headerName.innerText=users[other].chat;
  setStatus(true);
  load();
 }).catch(e=>error.innerText=e.message);
}

function logout(){
 setStatus(false);
 auth.signOut();
 location.reload();
}

function setStatus(v){
 db.collection("status").doc(me).set({
  online:v,typing:false,lastSeen:Date.now()
 });
 window.onbeforeunload=()=>setStatus(false);
}

msg.oninput=()=>{
 clearTimeout(typingTimer);
 db.collection("status").doc(me).update({typing:true});
 typingTimer=setTimeout(()=>db.collection("status").doc(me).update({typing:false}),1000);
};

function send(){
 if(!msg.value)return;
 db.collection("messages").add({
  from:me,to:other,text:msg.value,
  time:Date.now(),seen:false
 });
 msg.value="";
 db.collection("status").doc(me).update({typing:false});
}

function load(){
 let lastDate="";
 db.collection("messages").orderBy("time").onSnapshot(s=>{
  messages.innerHTML="";
  s.forEach(d=>{
   const m=d.data();
   if((m.from===me && m.to===other)||(m.from===other && m.to===me)){
    const date=new Date(m.time).toDateString();
    if(date!==lastDate){
     messages.innerHTML+=`<div class="date">${date}</div>`;
     lastDate=date;
    }
    const t=new Date(m.time);
    const time=t.toLocaleString("en-US",{hour:"numeric",minute:"numeric",hour12:true});
    const div=document.createElement("div");
    div.className="msg "+(m.from===me?"right":"left");
    div.innerHTML=`${m.text}<div class="small">${time} ${
      m.from===me?(m.seen?"<span class='pink'>‚úî‚úî</span>":"‚úî"):""
    }</div>`;
    if(m.from!==me && !m.seen) d.ref.update({seen:true});
    messages.appendChild(div);
   }
  });
  messages.scrollTop=messages.scrollHeight;
 });

 db.collection("status").doc(other).onSnapshot(d=>{
  const s=d.data();
  if(s?.online) headerStatus.innerText="online";
  else if(s?.lastSeen){
   const t=new Date(s.lastSeen);
   headerStatus.innerText="last seen "+t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  } else headerStatus.innerText="offline";
  typing.innerText=s?.typing?"typing...":"";
 });
}
</script>
</body>
</html>
